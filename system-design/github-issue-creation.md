# System Design: GitHub Issue Creation

This document outlines the end-to-end process for creating a GitHub issue from a recommendation generated by the analysis engine.

## 1. Overview

The GitHub issue creation flow allows users to create a new issue in their repository directly from the application's UI. This process involves a frontend component that captures the user's intent, a Next.js API route that acts as a proxy, and a backend service that securely communicates with the GitHub API.

## 2. Frontend Flow

The flow begins when a user decides to create a GitHub issue from a specific recommendation.

### Key Components

- **`frontend/src/app/components/display/IssuesList.tsx`**: This component renders the list of analysis recommendations and contains the button and logic to initiate issue creation.

### Step-by-Step

1.  **User Action**: The user clicks the "Create Issue" button associated with a specific recommendation in the `IssuesList` component.
2.  **`createGitHubIssue` Function**: This function is triggered by the user's click.
    - It gathers the necessary data for the new issue, including the title, a formatted body containing the description, code snippets, action items, and other details from the recommendation.
    - It also constructs a set of labels based on the issue's severity and category.
    - It makes a `POST` request to the internal Next.js API endpoint at `/api/github/issues`.
    - It handles loading states and displays error modals if the API call fails, for example, if the repository does not have a `.deployable` file.

## 3. API Route (Proxy)

The Next.js API route serves as a secure bridge between the frontend and the main backend service.

### Key Components

- **`frontend/src/app/api/github/issues/route.ts`**: This file contains the `POST` handler for the `/api/github/issues` endpoint.

### Step-by-Step

1.  **Request Reception**: The API route receives the `POST` request from the `createGitHubIssue` function.
2.  **Validation**: It performs initial validation on the request body.
3.  **Proxying**: It forwards the request to the main FastAPI backend. The backend URL is retrieved from environment variables (`process.env.BACKEND_API_URL`).
4.  **Response Handling**: It pipes the response from the backend back to the frontend. It also handles potential network errors and formats error messages to be displayed to the user.

## 4. Backend Flow

The FastAPI backend is responsible for the final communication with the GitHub API.

### Key Components

- **`backend/app/api/endpoints/github.py`**: This file contains the `/github/issues` endpoint that receives the proxied request.
- **`backend/app/mcp/github_api_client.py`**: This service (Micro-service Connection Point) encapsulates all direct interactions with the GitHub API.

### Step-by-Step

1.  **Request Handling**: The `/github/issues` endpoint in `github.py` receives the request from the Next.js proxy.
2.  **Pre-flight Checks**: Before creating the issue, the backend performs several critical checks using the `github_api_client`:
    - **Token Validation**: It ensures that the GitHub API token is valid.
    - **Repository Existence**: It verifies that the target repository exists and is accessible with the provided token.
    - **`.deployable` File Check**: It confirms that a `.deployable` file exists in the root of the repository. This is a security and configuration check to ensure the repository is opted-in for this service.
    - **Issues Enabled**: It checks if the "Issues" feature is enabled in the repository's settings.
3.  **Issue Creation**: If all checks pass, it calls the `create_issue` method in the `github_api_client`.
4.  **GitHub API Call**: The `github_api_client` makes an authenticated `POST` request to the official GitHub API (`https://api.github.com/repos/{owner}/{repo}/issues`) to create the issue.
5.  **Response**: The response from the GitHub API is returned up the chain to the frontend, which then updates the UI to show that the issue has been successfully created, typically by providing a link to the new issue on GitHub.

## 5. Implementation Checklist

- [ ] **Frontend**: Implement `createGitHubIssue` in `IssuesList.tsx`.
- [ ] **Frontend**: Create the Next.js API proxy route at `/api/github/issues`.
- [ ] **Backend**: Create the `/github/issues` endpoint in `github.py`.
- [ ] **Backend**: Implement the `github_api_client` with methods for checking repository status and creating issues.
- [ ] **Documentation**: Add docstrings to all new functions referencing this system design document.
